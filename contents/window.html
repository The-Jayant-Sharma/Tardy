<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Window — Tardy</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --green-light: rgba(144,238,144,0.4);
      --green-dark: rgba(0,200,0,0.6);
    }
    * { box-sizing: border-box; }

    /* MOBILE FIX → Allow vertical scrolling everywhere */
    html, body {
      height: 100%;
      overflow-y: auto;
    }

    body {
      margin:0;
      font-family:'Poppins',sans-serif;
      background:#ffffff;
      color:#111111;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-top:160px;
    }

    .header {
      padding:20px 20px;
      text-align:center;
      font-weight:800;
      font-size:28px;
      background:#ffffff;
      border-bottom:1px solid #e5e5e5;
      width:100%;
      position:fixed;
      top:0;
      left:0;
      z-index:10;
      border-radius:0 0 12px 12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.05);
      color:#111111;
    }

    .container {
      width:90%;
      max-width:800px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:30px;
      padding-bottom:40px;
    }

    .qbox {
      width:78vw;
      max-width:720px;
      height:75vh;
      overflow-y:auto; /* IMPORTANT FIX */
      background:#f8f8f8;
      padding:24px;
      border-radius:16px;
      border:1px solid #e0e0e0;
      box-shadow:0 12px 40px rgba(0,0,0,0.08);
      display:flex;
      flex-direction:column;
    }

    .qnum {
      font-weight:700;
      margin-bottom:20px;
      font-size:22px;
      color:#111111;
    }

    .question {
  font-size: 18px;
  min-height: 140px;
  overflow-x: auto;
  overflow-y: auto;
  white-space: normal;
  word-wrap: break-word;
  color: #111111;
}

    /* IMAGE HOLDER */
    #qimage-holder {
      width: 80%;
      max-width: 640px;
      margin: 16px auto 0 auto;
      display: none;
      text-align: center;
    }

    #qimage-holder img {
      width: 100%;
      height: auto;
      max-height: 28vh; /* OPTION A — Mobile safe */
      object-fit: contain;
      border-radius: 12px;
      border: 1px solid #ddd;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      display: block;
    }

    .options {
      display:flex;
      flex-direction:column;
      margin-top:20px;
      gap:16px;
      width:100%;
    }

    .opt {
      padding:16px 18px;
      border-radius:12px;
      border:1px solid #d0d0d0;
      background:#ffffff;
      cursor:pointer;
      transition:0.2s;
      display:flex;
      align-items:center;
      gap:12px;
      word-break:break-word;
      color:#111111;
    }

    .opt:hover {
      transform:translateY(-2px);
      box-shadow:0 6px 22px rgba(0,0,0,0.12);
    }

    .opt.selected {
      background:var(--green-light);
      border-color:rgba(0,150,0,0.3);
    }

    .opt.marked {
      background:var(--green-dark);
      border-color:rgba(0,120,0,0.4);
      cursor:not-allowed;
      color:white;
    }

    .nav {
      display:flex;
      justify-content:space-between;
      margin-top:25px;
      gap:12px;
      flex-wrap:wrap;
      width:100%;
    }

    .btn {
      padding:16px 20px;
      border-radius:14px;
      border:none;
      background:#111111;
      color:#ffffff;
      font-weight:700;
      cursor:pointer;
      transition:0.2s;
    }

    .btn:hover {
      transform:translateY(-2px);
      box-shadow:0 6px 22px rgba(0,0,0,0.12);
    }

    .btn:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }

    .progress {
      margin-top:18px;
      font-size:14px;
      opacity:0.9;
      text-align:center;
    }

   /* QUESTION GRID → 5 per row always */
.qpanel {
  display: grid;
  grid-template-columns: repeat(5, 48px); /* EXACT: 5 boxes per row */
  justify-content: center;
  gap: 12px;
  margin-top: 25px;
}

.qbox-item {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: #e0e0e0;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
  color: #111111;
}
   
    .qbox-item.answered {
      background:var(--green-light);
      color:white;
    }

    .qbox-item.marked {
      background:var(--green-dark);
      color:white;
      cursor:not-allowed;
    }

    #submitBtn {
      margin-top:30px;
      padding:10px 18px;
      min-width:320px;
      background:#111111;
      color:white;
      font-weight:600;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition:0.25s;
    }
    #submitBtn:hover { background:#333333; }

    #timerBox {
      width:220px;
      text-align:center;
      padding:12px 0;
      background:#f0f0f0;
      border-bottom:1px solid #d0d0d0;
      color:#111111;
      font-weight:700;
      border-radius:6px;
      font-size:20px;
      margin-top:20px;
    }

    /* PARTICLE CANVAS */
    canvas {
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      z-index:-1;
      pointer-events:none;
    }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/kjellmf/tikzjax/tikzjax.js"></script>
</head>

<body>
  <canvas id="particles"></canvas>

  <div class="header">Tardy — Exam Window</div>

  <div class="container">
    <div class="qbox" id="qbox">
      <div class="qnum" id="qnum">Question 1</div>
      <div class="question" id="question">Loading...</div>

      <!-- IMAGE BELOW QUESTION -->
      <div id="qimage-holder">
        <img id="qimage" src="" alt="Question image">
      </div>

      <div class="options" id="options"></div>

      <div class="nav">
        <button class="btn" id="prevBtn">Previous</button>
        <div style="display:flex;gap:8px">
          <button class="btn" id="markBtn">Mark</button>
          <button class="btn" id="nextBtn">Next</button>
        </div>
      </div>

      <div class="progress" id="progress">0 / 0</div>
    </div>

    <div class="qpanel" id="qpanel"></div>
    <div id="timerBox"></div>
    <button id="submitBtn">Submit Exam</button>
  </div>

<script>
/* =====================
   PARTICLE BACKGROUND
   ===================== */
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

const PARTICLE_COUNT = 120;
const particles = [];

for(let i=0; i<PARTICLE_COUNT; i++){
  particles.push({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    r: Math.random()*3 + 1,
    dx: (Math.random()-0.5)*0.6,
    dy: (Math.random()-0.5)*0.6,
    opacity: Math.random()*0.4 + 0.08
  });
}

function animateParticles(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  particles.forEach(p=>{
    ctx.beginPath();
    ctx.fillStyle=`rgba(0,0,0,${p.opacity})`;
    ctx.shadowBlur=8;
    ctx.shadowColor="rgba(0,0,0,0.20)";
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fill();

    p.x+=p.dx; p.y+=p.dy;
    if(p.x<0) p.x=canvas.width;
    if(p.x>canvas.width) p.x=0;
    if(p.y<0) p.y=canvas.height;
    if(p.y>canvas.height) p.y=0;
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

/* =====================
   EXAM ENGINE
   ===================== */
const sessionId = localStorage.getItem('selectedSession');
const displayName = localStorage.getItem('displayName')||'Guest';

let questions=[], current=0, responses=[], examDuration=0;
let perQuestionStart=0, timerInterval=null;
const SHEETDB_ENDPOINT="https://sheetdb.io/api/v1/o183fvrgl6r69";

function generateRandomString(n){
  const c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  return Array.from({length:n}, ()=>c[Math.floor(Math.random()*c.length)]).join("");
}

async function init(){
  if(!sessionId){
    alert("No session selected.");
    location.href="index.html";
    return;
  }

  try{
    const res = await fetch(`JSON/tests/${sessionId}.json`);
    if(!res.ok) throw new Error("JSON not found");

    const data = await res.json();
    questions = data.questions;
    examDuration = data.duration;

    responses = questions.map(()=>({ selected:null, marked:false, timeSpent:0 }));

    perQuestionStart = Date.now();
    renderQuestion(0);
    buildQPanel();
    startTimer(examDuration);

  } catch(e){
    alert("Failed to load test data.");
    location.href="index.html";
  }
}

function renderQuestion(i){
  if(i<0 || i>=questions.length) return;

  const now = Date.now();
  responses[current].timeSpent += Math.floor((now - perQuestionStart)/1000);

  current = i;
  perQuestionStart = Date.now();

  const q = questions[i];
  document.getElementById("qnum").textContent = `Question ${i+1} / ${questions.length}`;
  const qEl = document.getElementById("question");
  qEl.innerHTML = q.question;

  // IMAGE
  const imgHolder = document.getElementById("qimage-holder");
  const imgEl = document.getElementById("qimage");
  if(q.image){
    imgHolder.style.display="block";
    imgEl.src = q.image;
  } else {
    imgHolder.style.display="none";
    imgEl.src="";
  }

  const opts = document.getElementById("options");
  opts.innerHTML="";

  q.options.forEach((opt, idx)=>{
    const div=document.createElement("div");
    div.className="opt";
    div.innerHTML = `<div style="flex:1">${opt}</div>`;

    if(responses[i].selected===idx){
      div.classList.add(responses[i].marked ? "marked" : "selected");
    }

    div.addEventListener("click", ()=>{
      if(responses[i].marked) return;
      responses[i].selected = idx;
      [...opts.children].forEach(x=>x.classList.remove("selected","marked"));
      div.classList.add("selected");
      buildQPanel();
    });

    opts.appendChild(div);
  });

  document.getElementById("markBtn").style.display = responses[i].marked ? "none":"inline-block";

  if(window.MathJax) MathJax.typesetPromise([qEl,opts]).catch(()=>{});
  if(window.TikzJax) TikzJax.typeset([qEl]);

  updateNavButtons();
  updateProgress();
}

function buildQPanel(){
  const panel = document.getElementById("qpanel");
  panel.innerHTML="";

  questions.forEach((q, idx)=>{
    const b=document.createElement("div");
    b.className="qbox-item";
    b.textContent = idx+1;

    if(responses[idx].marked) b.classList.add("marked");
    else if(responses[idx].selected!==null) b.classList.add("answered");

    b.onclick = ()=>renderQuestion(idx);
    panel.appendChild(b);
  });
}

function startTimer(sec){
  const timerEl = document.getElementById("timerBox");
  const end = Date.now() + sec*1000;

  timerInterval=setInterval(()=>{
    const rem = Math.max(0, Math.floor((end - Date.now())/1000));
    const h = Math.floor(rem/3600),
          m = Math.floor((rem%3600)/60),
          s = rem%60;

    timerEl.textContent =
      `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;

    if(rem===0){
      clearInterval(timerInterval);
      submitExam();
    }
  }, 500);
}

function updateNavButtons(){
  document.getElementById("prevBtn").style.display = current===0 ? "none":"inline-block";
  document.getElementById("nextBtn").style.display = current===questions.length-1 ? "none":"inline-block";
}

function updateProgress(){
  const done = responses.filter(x=>x.selected!==null).length;
  document.getElementById("progress").textContent = `${done} / ${questions.length}`;
}

document.getElementById("prevBtn").onclick = ()=>{ if(current>0) renderQuestion(current-1); };
document.getElementById("nextBtn").onclick = ()=>{ if(current<questions.length-1) renderQuestion(current+1); };

document.getElementById("markBtn").onclick = ()=>{
  if(responses[current].selected===null) return;
  responses[current].marked=true;

  const opts = document.getElementById("options").children;
  [...opts].forEach((x,idx)=>{
    if(idx===responses[current].selected){
      x.classList.remove("selected");
      x.classList.add("marked");
    }
  });

  document.getElementById("markBtn").style.display="none";
  buildQPanel();
  updateProgress();
};

document.getElementById("submitBtn").onclick = submitExam;

async function submitExam(){
  clearInterval(timerInterval);

  responses[current].timeSpent +=
    Math.floor((Date.now() - perQuestionStart)/1000);

  const suffix = generateRandomString(10);
  const name = displayName + suffix;

  const result = {
    session: sessionId,
    displayName: name,
    totalQuestions: questions.length,
    correct:0,
    incorrect:0,
    notAttempted:0,
    questions:[]
  };

  questions.forEach((q,idx)=>{
    const sel = responses[idx].selected;
    let status="notAttempted";

    if(responses[idx].marked){
      if(sel===q.answer){ status="correct"; result.correct++; }
      else { status="incorrect"; result.incorrect++; }
    } else {
      result.notAttempted++;
    }

    result.questions.push({
      id: q.id,
      selected: sel,
      correctAnswer: q.answer,
      status,
      timeSpent: responses[idx].timeSpent
    });
  });

  try{
    await fetch(SHEETDB_ENDPOINT,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify([{
        "display-name":name,
        "unique-identifier":sessionId,
        "json":JSON.stringify(result)
      }])
    });
}catch(e){
    console.warn("Failed to upload results",e);
}

/* ================================
   NEW: Save to Local Storage
   ================================ */
localStorage.setItem("last_exam_submission", JSON.stringify(result));

alert("Exam submitted.");
location.href="result.html";
}

init();
</script>
</body>
</html>