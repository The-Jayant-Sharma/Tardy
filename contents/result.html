<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exam Result — Tardy</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --bg: #f6f7fb;
    --glass: rgba(255,255,255,0.65);
    --card-bg: rgba(255,255,255,0.6);
    --muted: #666;
    --accent: #111111;
    --success: rgba(144,238,144,0.8);
    --danger: rgba(255,99,71,0.85);
    --neutral: rgba(200,200,200,0.6);
  }

  html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(180deg,#fbfdff 0%, #f3f6fb 100%);color:var(--accent);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}

  /* particle canvas */
  #particles {
    position: fixed;
    inset: 0;
    width:100%;
    height:100%;
    z-index:0;
    pointer-events:none;
  }

  /* content wrapper */
  .page {
    position: relative;
    z-index: 5;
    width:100%;
    max-width:1100px;
    margin: 0 auto;
    padding: 24px;
    box-sizing: border-box;
  }

  .header {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    width: calc(100% - 48px);
    max-width:1100px;
    background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.6));
    backdrop-filter: blur(8px);
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: 0 8px 30px rgba(12,20,30,0.06);
    padding: 18px 20px;
    text-align: center;
    font-weight: 800;
    font-size: 20px;
  }

  .container {
    margin-top: 88px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    padding-bottom: 80px;
  }

  /* glass cards layout */
  .row {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  .glass {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 18px;
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: 0 10px 30px rgba(12,20,30,0.06);
    backdrop-filter: blur(6px);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:110px;
  }

  .glass h3{margin:0;font-size:14px;font-weight:700;color:var(--muted);letter-spacing:0.4px}
  .glass p{margin:8px 0 0 0;font-size:20px;font-weight:800;color:var(--accent)}

  /* Charts area */
  .charts {
    display:grid;
    grid-template-columns: 1.1fr .9fr;
    gap: 18px;
  }

  .chart-card {
    background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.55));
    border-radius: 12px;
    padding: 14px;
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: 0 10px 30px rgba(12,20,30,0.05);
  }

  .chart-title { font-weight:700;color:var(--muted); margin-bottom:8px; font-size:13px; }

  .charts-grid {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }

  .chart-box {
    padding:10px;
    background: rgba(255,255,255,0.4);
    border-radius:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:220px;
  }

  .chart-box canvas { width:100% !important; height: 220px !important; }

  /* Question list */
  .questions {
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .qitem {
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:space-between;
    padding:12px;
    border-radius:10px;
    background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.55));
    border: 1px solid rgba(255,255,255,0.6);
    box-shadow: 0 6px 18px rgba(12,20,30,0.04);
  }

  .qitem .left {
    display:flex;
    gap:10px;
    align-items:center;
  }

  .badge {
    width:36px;
    height:36px;
    border-radius:8px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    color:white;
  }

  .correct .badge{ background:linear-gradient(180deg,#7de07d,#4bbf59); }
  .incorrect .badge{ background:linear-gradient(180deg,#ff9a83,#ff5c3d); }
  .notAttempted .badge{ background:linear-gradient(180deg,#d2d2d2,#bdbdbd); color:#111; }

  .qmeta { font-size:13px;color:var(--muted); }

  /* responsive */
  @media (max-width: 900px){
    .charts { grid-template-columns: 1fr; }
    .charts-grid { grid-template-columns: 1fr 1fr; }
  }

  @media (max-width: 700px){
    .charts-grid { grid-template-columns: 1fr; }
    .glass p{ font-size: 18px; }
    .header{ font-size:18px; padding:14px 16px; }
    .chart-box canvas{ height: 180px !important; }
  }

  /* small helper */
  .muted { color:var(--muted); font-size:13px; }
  .center { text-align:center; }
  .legend-row { display:flex; gap:10px; align-items:center; justify-content:center; margin-top:8px; flex-wrap:wrap; }
  .legend-item { display:flex; gap:8px; align-items:center; font-size:13px; color:var(--muted); }
  .legend-swatch { width:12px;height:12px;border-radius:3px; }
</style>
</head>
<body>

<canvas id="particles"></canvas>

<div class="page">
  <div class="header">Exam Result — Tardy</div>

  <div class="container">

    <!-- summary cards -->
    <div class="row">
      <div class="glass" id="card-total"><h3>Total Questions</h3><p id="totalQ">0</p></div>
      <div class="glass" id="card-correct"><h3>Correct</h3><p id="totalCorrect">0</p></div>
      <div class="glass" id="card-incorrect"><h3>Incorrect</h3><p id="totalIncorrect">0</p></div>
      <div class="glass" id="card-notAttempted"><h3>Not Attempted</h3><p id="totalNot">0</p></div>
      <div class="glass" id="card-score"><h3>Total Score</h3><p id="totalScore">0</p></div>
    </div>

    <!-- charts area -->
    <div class="charts">
      <div class="chart-card">
        <div class="chart-title">Performance Overview</div>

        <div class="charts-grid">
          <div class="chart-box">
            <div class="chart-title">Marks per Question</div>
            <canvas id="marksChart"></canvas>
          </div>

          <div class="chart-box">
            <div class="chart-title">Time Spent per Question</div>
            <canvas id="timeChart"></canvas>
          </div>
        </div>

        <div class="legend-row" style="margin-top:12px;">
          <div class="legend-item"><span class="legend-swatch" style="background: #111"></span> Marks</div>
          <div class="legend-item"><span class="legend-swatch" style="background: rgba(0,0,0,0.08)"></span> Time (s)</div>
        </div>
      </div>

      <div class="chart-card center">
        <div class="chart-title">Result Distribution</div>
        <div class="chart-box" style="min-height:200px;">
          <canvas id="distributionChart"></canvas>
        </div>
        <div class="legend-row">
          <div class="legend-item"><span class="legend-swatch" style="background: linear-gradient(180deg,#7de07d,#4bbf59)"></span> Correct</div>
          <div class="legend-item"><span class="legend-swatch" style="background: linear-gradient(180deg,#ff9a83,#ff5c3d)"></span> Incorrect</div>
          <div class="legend-item"><span class="legend-swatch" style="background: linear-gradient(180deg,#d2d2d2,#bdbdbd)"></span> Not Attempted</div>
        </div>
      </div>
    </div>

    <!-- question list -->
    <div>
      <h3 style="margin:0 0 8px 0; font-weight:700; color:var(--muted)">Questions</h3>
      <div class="questions" id="qlist"></div>
    </div>

  </div>
</div>

<script>
/* ---------------------------
   Reactive particle system
   --------------------------- */
const canvas = document.getElementById('particles');
const ctx = canvas.getContext('2d');

let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

window.addEventListener('resize', ()=>{ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; });

const PT_COUNT = Math.max(60, Math.floor((W*H)/90000));
const pts = [];
const mouse = { x: -9999, y: -9999, down:false };

for(let i=0;i<PT_COUNT;i++){
  pts.push({
    x: Math.random()*W,
    y: Math.random()*H,
    r: Math.random()*2.6 + 0.8,
    vx: (Math.random()-0.5)*0.25,
    vy: (Math.random()-0.5)*0.25,
    baseOpacity: Math.random()*0.35 + 0.08,
    opacity: 0
  });
}

function updateParticles(){
  for(const p of pts){
    p.x += p.vx;
    p.y += p.vy;

    if(p.x < -10) p.x = W + 10;
    if(p.x > W + 10) p.x = -10;
    if(p.y < -10) p.y = H + 10;
    if(p.y > H + 10) p.y = -10;

    const dx = p.x - mouse.x;
    const dy = p.y - mouse.y;
    const dist2 = dx*dx + dy*dy;
    if(dist2 < 90*90){
      const dist = Math.sqrt(dist2) || 1;
      const strength = (90 - dist)/90 * 0.9;
      p.vx += (dx/dist) * strength * 0.08;
      p.vy += (dy/dist) * strength * 0.08;
    }

    p.vx *= 0.995;
    p.vy *= 0.995;

    p.opacity += (p.baseOpacity - p.opacity) * 0.04;
  }
}

function drawParticles(){
  ctx.clearRect(0,0,W,H);
  for(const p of pts){
    ctx.beginPath();
    ctx.fillStyle = `rgba(0,0,0,${p.opacity})`;
    ctx.shadowBlur = 6;
    ctx.shadowColor = 'rgba(0,0,0,0.12)';
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  }
}

function loop(){
  updateParticles();
  drawParticles();
  requestAnimationFrame(loop);
}
loop();

window.addEventListener('mousemove', (e)=>{
  mouse.x = e.clientX;
  mouse.y = e.clientY;
});
window.addEventListener('touchmove', (e)=>{
  if(e.touches && e.touches[0]) {
    mouse.x = e.touches[0].clientX;
    mouse.y = e.touches[0].clientY;
  }
});

/* ---------------------------
   Local-only Result Loading
   --------------------------- */

async function loadLocalResult() {
    const saved = localStorage.getItem("last_exam_submission");
    if (!saved) {
        alert("No saved exam data found.");
        return;
    }

    let result;
    try {
        result = JSON.parse(saved);
    } catch (e) {
        console.error(e);
        alert("Saved exam data is corrupted.");
        return;
    }

    /* ---------------------------
       FETCH MARKING SCHEME
       --------------------------- */
    const selectedSession = localStorage.getItem("selectedSession");
    if (!selectedSession) {
        alert("No session ID found.");
        return;
    }

    let marksData;
    try {
        const res = await fetch(`JSON/tests/${selectedSession}.json`);
        marksData = await res.json();
    } catch (e) {
        console.error(e);
        alert("Could not load marking scheme.");
        return;
    }

    const weight   = marksData.marks.full;
    const negative = marksData.marks.negative;
    const nullMark = marksData.marks.null;

    renderResult(result, weight, negative, nullMark);
}

function renderResult(result, weight, negative, nullMark){
    const totalCorrect = result.questions.filter(q=>q.status==='correct').length;
    const totalIncorrect = result.questions.filter(q=>q.status==='incorrect').length;
    const totalNotAttempted = result.questions.filter(q=>q.status==='notAttempted').length;
    const totalScore = result.questions.reduce((sum,q)=>{
        if(q.status==='correct') return sum+weight;
        if(q.status==='incorrect') return sum+negative;
        return sum+nullMark;
    },0);

    document.getElementById('totalQ').textContent = result.questions.length;
    document.getElementById('totalCorrect').textContent = totalCorrect;
    document.getElementById('totalIncorrect').textContent = totalIncorrect;
    document.getElementById('totalNot').textContent = totalNotAttempted;
    document.getElementById('totalScore').textContent = totalScore;

    const qlist = document.getElementById('qlist');
    qlist.innerHTML = '';
    result.questions.forEach((q, idx)=>{
      const div = document.createElement('div');
      div.className = 'qitem ' + (q.status==='correct' ? 'correct' : (q.status==='incorrect' ? 'incorrect' : 'notAttempted'));
      div.innerHTML = `
         <div class="left">
           <div class="badge">${idx+1}</div>
           <div>
             <div style="font-weight:700">Question ${idx+1}</div>
             <div class="qmeta">${q.status === 'correct' ? 'Correct' : (q.status === 'incorrect' ? 'Incorrect' : 'Not Attempted')}</div>
           </div>
         </div>
         <div style="display:flex;align-items:center;gap:12px">
           <div class="qmeta">Time: <strong>${q.timeSpent}s</strong></div>
           <div class="qmeta">Marks: <strong>${ q.status==='correct' ? weight : (q.status==='incorrect' ? negative : nullMark) }</strong></div>
         </div>
      `;
      qlist.appendChild(div);
    });

    const labels = result.questions.map((_,i)=>`Q${i+1}`);
    const marksData = result.questions.map(q=>{
      if(q.status==='correct') return weight;
      if(q.status==='incorrect') return negative;
      return nullMark;
    });
    const timeData = result.questions.map(q=>q.timeSpent);
    const distData = [totalCorrect, totalIncorrect, totalNotAttempted];

    const marksCtx = document.getElementById('marksChart').getContext('2d');
    const g1 = marksCtx.createLinearGradient(0,0,0,300);
    g1.addColorStop(0, 'rgba(17,17,17,0.85)');
    g1.addColorStop(1, 'rgba(17,17,17,0.25)');

    new Chart(marksCtx, {
      type:'bar',
      data:{
        labels,
        datasets:[{
          label:'Marks',
          data:marksData,
          backgroundColor: g1,
          borderRadius: 8,
          maxBarThickness: 36
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{
          x:{ grid:{ display:false } },
          y:{ beginAtZero:true }
        }
      }
    });

    const timeCtx = document.getElementById('timeChart').getContext('2d');
    const g2 = timeCtx.createLinearGradient(0,0,0,300);
    g2.addColorStop(0, 'rgba(17,17,17,0.18)');
    g2.addColorStop(1, 'rgba(17,17,17,0.02)');

    new Chart(timeCtx, {
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'Time (s)',
          data: timeData,
          borderColor: '#111',
          backgroundColor: g2,
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: '#111'
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ grid:{ display:false } }, y:{ beginAtZero:true } }
      }
    });

    const distCtx = document.getElementById('distributionChart').getContext('2d');

    new Chart(distCtx, {
      type:'doughnut',
      data:{
        labels:['Correct','Incorrect','Not Attempted'],
        datasets:[{
          data: distData,
          backgroundColor:[
            'rgba(123, 212, 119, 0.95)',
            'rgba(255,99,71,0.95)',
            'rgba(200,200,200,0.85)'
          ],
          hoverOffset: 8
        }]
      },
      options:{ responsive:true }
    });

    const scoreCard = document.getElementById('card-score');
    scoreCard.animate([
      { transform: 'scale(1)' },
      { transform: 'scale(1.02)' },
      { transform: 'scale(1)' }
    ], { duration: 800, easing:'ease-in-out' });
}

/* initialize */
loadLocalResult();
</script>
</body>
</html>