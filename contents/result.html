<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Result — Tardy</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin:0;
  font-family:'Poppins',sans-serif;
  background:#ffffff;
  color:#111111;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding-top:140px;
  padding-bottom:40px;
  overflow-y:auto;
}

.header {
  padding:20px;
  text-align:center;
  font-weight:800;
  font-size:28px;
  background:#ffffff;
  border-bottom:1px solid #e5e5e5;
  width:100%;
  position:fixed;
  top:0;
  left:0;
  z-index:10;
  border-radius:0 0 12px 12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.05);
}

.container {
  width:90%;
  max-width:1000px;
  display:flex;
  flex-direction:column;
  gap:30px;
}

.summary {
  display:flex;
  flex-wrap:wrap;
  gap:20px;
  justify-content:space-between;
}

.stat-card {
  flex:1 1 200px;
  background:#f8f8f8;
  padding:20px;
  border-radius:16px;
  border:1px solid #e0e0e0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  min-width:200px;
  box-shadow:0 8px 20px rgba(0,0,0,0.06);
}

.stat-card h3 {
  margin:0 0 10px;
  font-size:18px;
  font-weight:700;
  color:#111111;
}

.stat-card p {
  margin:0;
  font-size:16px;
  font-weight:600;
  color:#111111;
}

.charts {
  display:flex;
  flex-wrap:wrap;
  gap:30px;
  justify-content:center;
  align-items:flex-start;
}

.chart-box {
  flex:1 1 300px; /* default width for bar and line */
  background:#f8f8f8;
  border-radius:16px;
  padding:20px;
  border:1px solid #e0e0e0;
  box-shadow:0 8px 20px rgba(0,0,0,0.06);
  display:flex;
  justify-content:center;
  align-items:center;
}

.chart-box canvas {
  width:100% !important;
  height:300px !important;
}

/* Pie chart narrower */
#distributionChart {
  max-width:250px !important;
  max-height:250px !important;
}

.questions {
  display:flex;
  flex-direction:column;
  gap:12px;
}

.qitem {
  background:#f0f0f0;
  padding:12px;
  border-radius:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

.correct { background:rgba(144,238,144,0.4); }
.incorrect { background:rgba(255,99,71,0.4); }
.notAttempted { background:rgba(200,200,200,0.3); }

.timeSpent {
  font-size:0.9em;
  color:#111111;
  margin-left:8px;
}

@media(max-width:700px){
  .charts { flex-direction:column; gap:20px; }
  .chart-box { width:100%; max-width:100%; }
  .summary { flex-direction:column; }
}
</style>
</head>
<body>

<div class="header">Exam Result — Tardy</div>
<div class="container">

  <!-- Summary Cards -->
  <div class="summary" id="summaryCards"></div>

  <!-- Charts -->
  <div class="charts">
    <div class="chart-box">
      <canvas id="marksChart"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="timeChart"></canvas>
    </div>
    <div class="chart-box">
      <canvas id="distributionChart"></canvas>
    </div>
  </div>

  <!-- Question List -->
  <div class="questions" id="qlist"></div>
</div>

<script>
const SHEETDB_ENDPOINT="https://sheetdb.io/api/v1/o183fvrgl6r69";
const username = localStorage.getItem('displayName') || 'Guest';
const suffix = sessionStorage.getItem('lastRandomSuffix');
const uniqueName = username + suffix;

async function fetchResult(){
    try{
        const res = await fetch(`${SHEETDB_ENDPOINT}?display-name=${encodeURIComponent(uniqueName)}`);
        if(!res.ok) throw new Error('Failed to fetch');
        const data = await res.json();
        if(!data.length) throw new Error('No data');
        const resultJson = JSON.parse(data[data.length-1].json);
        fetchTestConfig(resultJson);
    }catch(e){console.error(e); alert('Failed to fetch result');}
}

async function fetchTestConfig(result){
    try{
        const uid = result.session;
        const res = await fetch(`JSON/tests/${uid}.json`);
        if(!res.ok) throw new Error('Failed to fetch test config');
        const testData = await res.json();

        const weight = testData.marks.full || 1;
        const negative = testData.marks.negative || 0;
        const nullMark = testData.marks.null || 0;

        renderResult(result, weight, negative, nullMark);
    }catch(e){console.error(e); alert('Failed to fetch test configuration');}
}

function renderResult(result, weight, negative, nullMark){
    // Summary Cards
    const totalCorrect = result.questions.filter(q=>q.status==='correct').length;
    const totalIncorrect = result.questions.filter(q=>q.status==='incorrect').length;
    const totalNotAttempted = result.questions.filter(q=>q.status==='notAttempted').length;
    const totalScore = result.questions.reduce((sum,q)=>{
        if(q.status==='correct') return sum+weight;
        if(q.status==='incorrect') return sum+negative;
        return sum+nullMark;
    },0);

    const summaryCards = document.getElementById('summaryCards');
    summaryCards.innerHTML = `
      <div class="stat-card"><h3>Total Questions</h3><p>${result.questions.length}</p></div>
      <div class="stat-card"><h3>Correct</h3><p>${totalCorrect}</p></div>
      <div class="stat-card"><h3>Incorrect</h3><p>${totalIncorrect}</p></div>
      <div class="stat-card"><h3>Not Attempted</h3><p>${totalNotAttempted}</p></div>
      <div class="stat-card"><h3>Total Score</h3><p>${totalScore}</p></div>
    `;

    // Question List
    const qlist = document.getElementById('qlist');
    qlist.innerHTML = '';
    result.questions.forEach((q,idx)=>{
        const div = document.createElement('div');
        div.className='qitem ' + (q.status==='correct'?'correct':(q.status==='incorrect'?'incorrect':'notAttempted'));
        let marksObtained = 0;
        if(q.status==='correct') marksObtained = weight;
        else if(q.status==='incorrect') marksObtained = negative;
        else if(q.status==='notAttempted') marksObtained = nullMark;

        div.innerHTML = `<span>Question ${idx+1}: ${q.status}</span><span class='timeSpent'>Time spent: ${q.timeSpent}s | Marks: ${marksObtained}</span>`;
        qlist.appendChild(div);
    });

    // Charts
    const labels = result.questions.map((_,i)=>`Q${i+1}`);
    const marksData = result.questions.map(q=>{
        if(q.status==='correct') return weight;
        if(q.status==='incorrect') return negative;
        return nullMark;
    });
    const timeData = result.questions.map(q=>q.timeSpent);
    const distData = [totalCorrect, totalIncorrect, totalNotAttempted];

    new Chart(document.getElementById('marksChart'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'Marks per Question', data:marksData, backgroundColor:'#111111', borderRadius:8 }]},
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
    });

    new Chart(document.getElementById('timeChart'),{
        type:'line',
        data:{ labels, datasets:[{ label:'Time Spent (s)', data:timeData, borderColor:'#111111', backgroundColor:'rgba(0,0,0,0.05)', fill:true, tension:0.3, pointRadius:5 }]},
        options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
    });

    new Chart(document.getElementById('distributionChart'),{
        type:'doughnut',
        data:{ labels:['Correct','Incorrect','Not Attempted'], datasets:[{ data:distData, backgroundColor:['rgba(144,238,144,0.6)','rgba(255,99,71,0.6)','rgba(200,200,200,0.5)'], borderWidth:1 }]},
        options:{ responsive:true, plugins:{legend:{position:'bottom'}} }
    });
}

fetchResult();
</script>
</body>
</html>